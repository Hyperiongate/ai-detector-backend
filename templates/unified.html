{% extends "base.html" %}

{% block title %}Unified Analysis - Facts & Fakes AI{% endblock %}

{% block head %}
<meta name="description" content="Comprehensive multi-modal AI content analysis - detect AI-generated text, verify news authenticity, check plagiarism, and analyze images all in one place.">
<meta name="keywords" content="AI detection, news verification, plagiarism check, image analysis, content authenticity, multi-modal analysis">
<link rel="canonical" href="{{ url_for('unified_analysis', _external=True) }}">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="{{ url_for('unified_analysis', _external=True) }}">
<meta property="og:title" content="Unified Analysis - Facts & Fakes AI">
<meta property="og:description" content="Comprehensive multi-modal AI content analysis - detect AI-generated text, verify news authenticity, check plagiarism, and analyze images all in one place.">
<meta property="og:image" content="{{ url_for('static', filename='images/unified-analysis-og.jpg', _external=True) }}">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="{{ url_for('unified_analysis', _external=True) }}">
<meta property="twitter:title" content="Unified Analysis - Facts & Fakes AI">
<meta property="twitter:description" content="Comprehensive multi-modal AI content analysis - detect AI-generated text, verify news authenticity, check plagiarism, and analyze images all in one place.">
<meta property="twitter:image" content="{{ url_for('static', filename='images/unified-analysis-twitter.jpg', _external=True) }}">

<style>
    .unified-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .unified-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px 20px;
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        border-radius: 15px;
        color: white;
        box-shadow: 0 8px 32px rgba(74, 144, 226, 0.3);
    }

    .unified-header h1 {
        font-size: 2.5em;
        margin-bottom: 15px;
        font-weight: 700;
    }

    .unified-header p {
        font-size: 1.2em;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
    }

    .analysis-modes {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }

    .mode-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: 2px solid transparent;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .mode-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(74, 144, 226, 0.2);
        border-color: #4a90e2;
    }

    .mode-card.active {
        border-color: #4a90e2;
        background: linear-gradient(135deg, #f8fbff 0%, #e8f4ff 100%);
    }

    .mode-card i {
        font-size: 2.5em;
        color: #4a90e2;
        margin-bottom: 15px;
    }

    .mode-card h3 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 1.3em;
    }

    .mode-card p {
        color: #7f8c8d;
        font-size: 0.95em;
        line-height: 1.5;
    }

    .input-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .input-tabs {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        border-bottom: 2px solid #ecf0f1;
    }

    .input-tab {
        padding: 12px 20px;
        background: none;
        border: none;
        font-size: 1em;
        color: #7f8c8d;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .input-tab.active {
        color: #4a90e2;
        border-bottom-color: #4a90e2;
        font-weight: 600;
    }

    .input-panel {
        display: none;
    }

    .input-panel.active {
        display: block;
    }

    .url-input-group {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .url-input {
        flex: 1;
        padding: 15px;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s ease;
    }

    .url-input:focus {
        outline: none;
        border-color: #4a90e2;
    }

    .text-input {
        width: 100%;
        min-height: 200px;
        padding: 15px;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        font-size: 1em;
        font-family: inherit;
        resize: vertical;
        transition: border-color 0.3s ease;
    }

    .text-input:focus {
        outline: none;
        border-color: #4a90e2;
    }

    .file-upload-area {
        border: 2px dashed #bdc3c7;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .file-upload-area:hover {
        border-color: #4a90e2;
        background: #f0f8ff;
    }

    .file-upload-area.dragover {
        border-color: #4a90e2;
        background: #e8f4ff;
    }

    .file-upload-area i {
        font-size: 3em;
        color: #bdc3c7;
        margin-bottom: 15px;
    }

    .file-upload-area p {
        color: #7f8c8d;
        margin-bottom: 10px;
    }

    .file-upload-area small {
        color: #95a5a6;
        font-size: 0.9em;
    }

    .file-preview {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #ecf0f1;
    }

    .file-preview img {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .analyze-button {
        background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 1.1em;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
    }

    .analyze-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
    }

    .analyze-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .progress-container {
        display: none;
        margin-top: 30px;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 20px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4a90e2, #357abd);
        border-radius: 4px;
        transition: width 0.3s ease;
        width: 0%;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .progress-step {
        flex: 1;
        text-align: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 0 5px;
        transition: all 0.3s ease;
    }

    .progress-step.active {
        background: #4a90e2;
        color: white;
    }

    .progress-step.completed {
        background: #27ae60;
        color: white;
    }

    .progress-text {
        text-align: center;
        color: #7f8c8d;
        font-style: italic;
    }

    .results-container {
        display: none;
        margin-top: 30px;
    }

    .results-header {
        background: linear-gradient(135deg, #27ae60 0%, #219a52 100%);
        color: white;
        padding: 25px;
        border-radius: 12px 12px 0 0;
        text-align: center;
    }

    .results-header h2 {
        margin-bottom: 10px;
        font-size: 1.8em;
    }

    .results-header p {
        opacity: 0.9;
        font-size: 1.1em;
    }

    .results-content {
        background: white;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .results-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #ecf0f1;
    }

    .results-tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        background: none;
        border: none;
        font-size: 1em;
        color: #7f8c8d;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
    }

    .results-tab.active {
        color: #4a90e2;
        border-bottom-color: #4a90e2;
        background: white;
    }

    .results-panel {
        display: none;
        padding: 30px;
    }

    .results-panel.active {
        display: block;
    }

    .analysis-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        border-left: 4px solid #4a90e2;
    }

    .analysis-card h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.4em;
    }

    .confidence-bar {
        width: 100%;
        height: 20px;
        background: #ecf0f1;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
        position: relative;
    }

    .confidence-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.8s ease;
        position: relative;
    }

    .confidence-fill.high {
        background: linear-gradient(90deg, #e74c3c, #c0392b);
    }

    .confidence-fill.medium {
        background: linear-gradient(90deg, #f39c12, #e67e22);
    }

    .confidence-fill.low {
        background: linear-gradient(90deg, #27ae60, #219a52);
    }

    .confidence-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: 600;
        font-size: 0.9em;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .key-findings {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
        border: 1px solid #ecf0f1;
    }

    .key-findings h4 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 1.1em;
    }

    .key-findings ul {
        list-style: none;
        padding: 0;
    }

    .key-findings li {
        padding: 8px 0;
        border-bottom: 1px solid #ecf0f1;
        color: #34495e;
    }

    .key-findings li:last-child {
        border-bottom: none;
    }

    .key-findings li i {
        color: #4a90e2;
        margin-right: 8px;
    }

    .download-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        text-align: center;
    }

    .download-button {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        color: white;
        border: none;
        padding: 12px 25px;
        font-size: 1em;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        margin: 0 10px;
    }

    .download-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
    }

    .error-container {
        display: none;
        background: #fff5f5;
        border: 1px solid #fed7d7;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        color: #e53e3e;
    }

    .error-container h3 {
        margin-bottom: 10px;
        color: #e53e3e;
    }

    .retry-button {
        background: #e53e3e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
        transition: background 0.3s ease;
    }

    .retry-button:hover {
        background: #c53030;
    }

    .tier-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .tier-option {
        flex: 1;
        padding: 20px;
        background: white;
        border: 2px solid #ecf0f1;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .tier-option:hover {
        border-color: #4a90e2;
    }

    .tier-option.active {
        border-color: #4a90e2;
        background: #f0f8ff;
    }

    .tier-option h4 {
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .tier-option p {
        color: #7f8c8d;
        font-size: 0.9em;
    }

    .tier-badge {
        background: #4a90e2;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .loading-spinner {
        background: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #ecf0f1;
        border-top: 4px solid #4a90e2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        text-align: center;
    }

    .summary-card h2 {
        margin-bottom: 15px;
        font-size: 2em;
    }

    .summary-stats {
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
    }

    .summary-stat {
        text-align: center;
    }

    .summary-stat .number {
        font-size: 2.5em;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .summary-stat .label {
        opacity: 0.9;
        font-size: 0.9em;
    }

    @media (max-width: 768px) {
        .unified-header h1 {
            font-size: 2em;
        }

        .unified-header p {
            font-size: 1em;
        }

        .analysis-modes {
            grid-template-columns: 1fr;
        }

        .input-tabs {
            flex-direction: column;
        }

        .url-input-group {
            flex-direction: column;
        }

        .results-tabs {
            flex-direction: column;
        }

        .tier-selector {
            flex-direction: column;
        }

        .summary-stats {
            flex-direction: column;
            gap: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="unified-container">
    <!-- Header Section -->
    <div class="unified-header">
        <h1><i class="fas fa-search-plus"></i> Unified Analysis</h1>
        <p>Comprehensive multi-modal content analysis combining AI detection, news verification, plagiarism checking, and image authenticity in one powerful platform.</p>
    </div>

    <!-- Analysis Mode Selection -->
    <div class="analysis-modes">
        <div class="mode-card active" data-mode="comprehensive">
            <i class="fas fa-layer-group"></i>
            <h3>Comprehensive Analysis</h3>
            <p>Full multi-modal analysis including AI detection, plagiarism checking, and content verification</p>
        </div>
        <div class="mode-card" data-mode="ai-focused">
            <i class="fas fa-robot"></i>
            <h3>AI-Focused Analysis</h3>
            <p>Specialized detection of AI-generated content with advanced linguistic analysis</p>
        </div>
        <div class="mode-card" data-mode="authenticity">
            <i class="fas fa-shield-alt"></i>
            <h3>Authenticity Check</h3>
            <p>Verify content originality and detect potential manipulation or fabrication</p>
        </div>
        <div class="mode-card" data-mode="news-verification">
            <i class="fas fa-newspaper"></i>
            <h3>News Verification</h3>
            <p>Specialized analysis for news articles with bias detection and fact-checking</p>
        </div>
    </div>

    <!-- Analysis Tier Selection -->
    <div class="tier-selector">
        <div class="tier-option active" data-tier="basic">
            <h4>Basic Analysis <span class="tier-badge">Free</span></h4>
            <p>Standard detection algorithms with essential insights</p>
        </div>
        <div class="tier-option" data-tier="professional">
            <h4>Professional Analysis <span class="tier-badge">Pro</span></h4>
            <p>Advanced AI models with comprehensive reporting and detailed insights</p>
        </div>
    </div>

    <!-- Input Section -->
    <div class="input-section">
        <div class="input-tabs">
            <button class="input-tab active" data-tab="url">URL Analysis</button>
            <button class="input-tab" data-tab="text">Text Analysis</button>
            <button class="input-tab" data-tab="file">File Upload</button>
        </div>

        <!-- URL Input Panel -->
        <div class="input-panel active" id="url-panel">
            <div class="url-input-group">
                <input type="url" class="url-input" id="url-input" placeholder="Enter URL to analyze (news articles, social media posts, etc.)">
                <button class="analyze-button" onclick="startAnalysis('url')">
                    <i class="fas fa-search"></i> Analyze URL
                </button>
            </div>
            <small style="color: #7f8c8d;">Supports news articles, blog posts, social media content, and other web pages</small>
        </div>

        <!-- Text Input Panel -->
        <div class="input-panel" id="text-panel">
            <textarea class="text-input" id="text-input" placeholder="Paste your text content here for analysis..."></textarea>
            <div style="margin-top: 15px;">
                <button class="analyze-button" onclick="startAnalysis('text')">
                    <i class="fas fa-search"></i> Analyze Text
                </button>
            </div>
            <small style="color: #7f8c8d;">Minimum 50 characters required for accurate analysis</small>
        </div>

        <!-- File Upload Panel -->
        <div class="input-panel" id="file-panel">
            <div class="file-upload-area" id="file-upload-area">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>Click to upload or drag and drop files here</p>
                <small>Supported formats: PDF, DOC, DOCX, TXT, JPG, PNG, GIF (Max 10MB)</small>
            </div>
            <input type="file" id="file-input" style="display: none;" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif">
            <div class="file-preview" id="file-preview" style="display: none;"></div>
            <div style="margin-top: 15px;">
                <button class="analyze-button" onclick="startAnalysis('file')" disabled id="file-analyze-button">
                    <i class="fas fa-search"></i> Analyze File
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-container" id="progress-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="progress-steps" id="progress-steps">
            <div class="progress-step active">Initializing</div>
            <div class="progress-step">Content Processing</div>
            <div class="progress-step">AI Detection</div>
            <div class="progress-step">Plagiarism Check</div>
            <div class="progress-step">Generating Report</div>
        </div>
        <div class="progress-text" id="progress-text">Preparing analysis...</div>
    </div>

    <!-- Results Section -->
    <div class="results-container" id="results-container">
        <div class="results-header">
            <h2><i class="fas fa-check-circle"></i> Analysis Complete</h2>
            <p>Comprehensive multi-modal analysis results</p>
        </div>
        <div class="results-content">
            <!-- Summary Card -->
            <div class="summary-card" id="summary-card">
                <h2>Overall Assessment</h2>
                <p id="summary-text">Analysis completed successfully</p>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="number" id="ai-confidence">0%</div>
                        <div class="label">AI Detection</div>
                    </div>
                    <div class="summary-stat">
                        <div class="number" id="authenticity-score">0%</div>
                        <div class="label">Authenticity</div>
                    </div>
                    <div class="summary-stat">
                        <div class="number" id="originality-score">0%</div>
                        <div class="label">Originality</div>
                    </div>
                </div>
            </div>

            <!-- Results Tabs -->
            <div class="results-tabs">
                <button class="results-tab active" data-tab="overview">Overview</button>
                <button class="results-tab" data-tab="ai-analysis">AI Analysis</button>
                <button class="results-tab" data-tab="plagiarism">Plagiarism</button>
                <button class="results-tab" data-tab="authenticity">Authenticity</button>
                <button class="results-tab" data-tab="technical">Technical</button>
            </div>

            <!-- Overview Panel -->
            <div class="results-panel active" id="overview-panel">
                <div class="analysis-card">
                    <h3><i class="fas fa-chart-line"></i> Analysis Summary</h3>
                    <div id="overview-content">
                        <p>Detailed analysis results will appear here...</p>
                    </div>
                </div>
            </div>

            <!-- AI Analysis Panel -->
            <div class="results-panel" id="ai-analysis-panel">
                <div class="analysis-card">
                    <h3><i class="fas fa-robot"></i> AI Detection Results</h3>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="ai-confidence-bar" style="width: 0%;">
                            <div class="confidence-text" id="ai-confidence-text">0%</div>
                        </div>
                    </div>
                    <div class="key-findings">
                        <h4>Key Findings</h4>
                        <ul id="ai-findings"></ul>
                    </div>
                </div>
            </div>

            <!-- Plagiarism Panel -->
            <div class="results-panel" id="plagiarism-panel">
                <div class="analysis-card">
                    <h3><i class="fas fa-copy"></i> Plagiarism Check Results</h3>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="plagiarism-confidence-bar" style="width: 0%;">
                            <div class="confidence-text" id="plagiarism-confidence-text">0%</div>
                        </div>
                    </div>
                    <div class="key-findings">
                        <h4>Source Matches</h4>
                        <ul id="plagiarism-findings"></ul>
                    </div>
                </div>
            </div>

            <!-- Authenticity Panel -->
            <div class="results-panel" id="authenticity-panel">
                <div class="analysis-card">
                    <h3><i class="fas fa-shield-alt"></i> Authenticity Assessment</h3>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="authenticity-confidence-bar" style="width: 0%;">
                            <div class="confidence-text" id="authenticity-confidence-text">0%</div>
                        </div>
                    </div>
                    <div class="key-findings">
                        <h4>Authenticity Indicators</h4>
                        <ul id="authenticity-findings"></ul>
                    </div>
                </div>
            </div>

            <!-- Technical Panel -->
            <div class="results-panel" id="technical-panel">
                <div class="analysis-card">
                    <h3><i class="fas fa-cogs"></i> Technical Analysis</h3>
                    <div id="technical-content">
                        <p>Technical analysis details will appear here...</p>
                    </div>
                </div>
            </div>

            <!-- Download Section -->
            <div class="download-section">
                <h3>Download Reports</h3>
                <button class="download-button" onclick="downloadReport('pdf')">
                    <i class="fas fa-file-pdf"></i> Download PDF Report
                </button>
                <button class="download-button" onclick="downloadReport('detailed')">
                    <i class="fas fa-file-alt"></i> Download Detailed Report
                </button>
            </div>
        </div>
    </div>

    <!-- Error Container -->
    <div class="error-container" id="error-container">
        <h3><i class="fas fa-exclamation-triangle"></i> Analysis Error</h3>
        <p id="error-message">An error occurred during analysis.</p>
        <button class="retry-button" onclick="retryAnalysis()">
            <i class="fas fa-redo"></i> Retry Analysis
        </button>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p>Processing your content...</p>
        <small>This may take a few moments for comprehensive analysis</small>
    </div>
</div>

<script>
// Global variables
let currentAnalysisMode = 'comprehensive';
let currentTier = 'basic';
let currentInputType = 'url';
let analysisResults = null;
let progressInterval = null;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeUnifiedAnalysis();
});

function initializeUnifiedAnalysis() {
    // Set up mode selection
    document.querySelectorAll('.mode-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            currentAnalysisMode = this.dataset.mode;
        });
    });

    // Set up tier selection
    document.querySelectorAll('.tier-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.tier-option').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            currentTier = this.dataset.tier;
        });
    });

    // Set up input tabs
    document.querySelectorAll('.input-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            switchInputTab(tabName);
        });
    });

    // Set up results tabs
    document.querySelectorAll('.results-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            switchResultsTab(tabName);
        });
    });

    // Set up file upload
    setupFileUpload();

    // Set up keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
            const activeTab = document.querySelector('.input-tab.active').dataset.tab;
            startAnalysis(activeTab);
        }
    });
}

function switchInputTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.input-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

    // Update panels
    document.querySelectorAll('.input-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    document.getElementById(`${tabName}-panel`).classList.add('active');

    currentInputType = tabName;
}

function switchResultsTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.results-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

    // Update panels
    document.querySelectorAll('.results-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    document.getElementById(`${tabName}-panel`).classList.add('active');
}

function setupFileUpload() {
    const fileUploadArea = document.getElementById('file-upload-area');
    const fileInput = document.getElementById('file-input');
    const filePreview = document.getElementById('file-preview');
    const fileAnalyzeButton = document.getElementById('file-analyze-button');

    // Click to upload
    fileUploadArea.addEventListener('click', function() {
        fileInput.click();
    });

    // Drag and drop
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
}

function handleFileSelect(file) {
    const filePreview = document.getElementById('file-preview');
    const fileAnalyzeButton = document.getElementById('file-analyze-button');
    
    // Check file size (10MB limit)
    if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        return;
    }

    // Show preview
    filePreview.style.display = 'block';
    
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            filePreview.innerHTML = `
                <p><strong>File:</strong> ${file.name}</p>
                <p><strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                <img src="${e.target.result}" alt="Preview">
            `;
        };
        reader.readAsDataURL(file);
    } else {
        filePreview.innerHTML = `
            <p><strong>File:</strong> ${file.name}</p>
            <p><strong>Type:</strong> ${file.type}</p>
            <p><strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
        `;
    }

    // Enable analyze button
    fileAnalyzeButton.disabled = false;
}

function startAnalysis(inputType) {
    let content = '';
    let contentType = 'text';

    // Get content based on input type
    if (inputType === 'url') {
        content = document.getElementById('url-input').value.trim();
        contentType = 'url';
        if (!content) {
            alert('Please enter a URL to analyze');
            return;
        }
        if (!isValidUrl(content)) {
            alert('Please enter a valid URL');
            return;
        }
    } else if (inputType === 'text') {
        content = document.getElementById('text-input').value.trim();
        contentType = 'text';
        if (!content) {
            alert('Please enter text to analyze');
            return;
        }
        if (content.length < 50) {
            alert('Text must be at least 50 characters long for accurate analysis');
            return;
        }
    } else if (inputType === 'file') {
        const fileInput = document.getElementById('file-input');
        if (!fileInput.files.length) {
            alert('Please select a file to analyze');
            return;
        }
        contentType = 'file';
        content = fileInput.files[0];
    }

    // Show progress
    showProgress();

    // Start analysis
    performUnifiedAnalysis(content, contentType);
}

function performUnifiedAnalysis(content, contentType) {
    // Show loading overlay
    document.getElementById('loading-overlay').style.display = 'flex';

    // Prepare request data
    const requestData = {
        content: content,
        type: contentType,
        mode: currentAnalysisMode,
        tier: currentTier,
        is_pro: currentTier === 'professional'
    };

    // If file upload, use FormData
    if (contentType === 'file') {
        const formData = new FormData();
        formData.append('file', content);
        formData.append('mode', currentAnalysisMode);
        formData.append('tier', currentTier);
        formData.append('is_pro', currentTier === 'professional');
        
        fetch('/api/analyze-unified', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => handleAnalysisResponse(data))
        .catch(error => handleAnalysisError(error));
    } else {
        fetch('/api/analyze-unified', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => handleAnalysisResponse(data))
        .catch(error => handleAnalysisError(error));
    }
}

function handleAnalysisResponse(data) {
    // Hide loading overlay
    document.getElementById('loading-overlay').style.display = 'none';

    if (data.success) {
        analysisResults = data.results;
        displayResults(data.results);
        completeProgress();
    } else {
        handleAnalysisError(data.error || 'Analysis failed');
    }
}

function handleAnalysisError(error) {
    // Hide loading overlay
    document.getElementById('loading-overlay').style.display = 'none';
    
    // Hide progress
    document.getElementById('progress-container').style.display = 'none';
    
    // Show error
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    
    errorMessage.textContent = typeof error === 'string' ? error : 'An unexpected error occurred during analysis';
    errorContainer.style.display = 'block';
    
    console.error('Analysis error:', error);
}

function displayResults(results) {
    const resultsContainer = document.getElementById('results-container');
    
    // Update summary card
    updateSummaryCard(results);
    
    // Update each analysis panel
    updateOverviewPanel(results);
    updateAIAnalysisPanel(results);
    updatePlagiarismPanel(results);
    updateAuthenticityPanel(results);
    updateTechnicalPanel(results);
    
    // Show results
    resultsContainer.style.display = 'block';
    
    // Scroll to results
    resultsContainer.scrollIntoView({ behavior: 'smooth' });
}

function updateSummaryCard(results) {
    const summaryText = document.getElementById('summary-text');
    const aiConfidence = document.getElementById('ai-confidence');
    const authenticityScore = document.getElementById('authenticity-score');
    const originalityScore = document.getElementById('originality-score');
    
    // Update summary text
    if (results.summary) {
        summaryText.textContent = results.summary;
    }
    
    // Update scores
    if (results.ai_analysis) {
        aiConfidence.textContent = Math.round(results.ai_analysis.confidence || 0) + '%';
    }
    
    if (results.authenticity) {
        authenticityScore.textContent = Math.round(results.authenticity.score || 0) + '%';
    }
    
    if (results.plagiarism) {
        const originality = 100 - (results.plagiarism.similarity_score || 0);
        originalityScore.textContent = Math.round(originality) + '%';
    }
}

function updateOverviewPanel(results) {
    const overviewContent = document.getElementById('overview-content');
    
    let html = '';
    
    if (results.overview) {
        html = `<p>${results.overview}</p>`;
    } else {
        html = '<div class="key-findings"><h4>Analysis Summary</h4><ul>';
        
        if (results.ai_analysis) {
            html += `<li><i class="fas fa-robot"></i> AI Detection: ${results.ai_analysis.confidence || 0}% confidence</li>`;
        }
        
        if (results.plagiarism) {
            html += `<li><i class="fas fa-copy"></i> Plagiarism Check: ${results.plagiarism.similarity_score || 0}% similarity found</li>`;
        }
        
        if (results.authenticity) {
            html += `<li><i class="fas fa-shield-alt"></i> Authenticity: ${results.authenticity.score || 0}% authentic</li>`;
        }
        
        html += '</ul></div>';
    }
    
    overviewContent.innerHTML = html;
}

function updateAIAnalysisPanel(results) {
    const aiConfidenceBar = document.getElementById('ai-confidence-bar');
    const aiConfidenceText = document.getElementById('ai-confidence-text');
    const aiFindings = document.getElementById('ai-findings');
    
    if (results.ai_analysis) {
        const confidence = results.ai_analysis.confidence || 0;
        
        // Update confidence bar
        aiConfidenceBar.style.width = confidence + '%';
        aiConfidenceText.textContent = Math.round(confidence) + '%';
        
        // Set color based on confidence
        if (confidence > 70) {
            aiConfidenceBar.className = 'confidence-fill high';
        } else if (confidence > 30) {
            aiConfidenceBar.className = 'confidence-fill medium';
        } else {
            aiConfidenceBar.className = 'confidence-fill low';
        }
        
        // Update findings
        let findingsHtml = '';
        if (results.ai_analysis.findings) {
            results.ai_analysis.findings.forEach(finding => {
                findingsHtml += `<li><i class="fas fa-chevron-right"></i> ${finding}</li>`;
            });
        }
        aiFindings.innerHTML = findingsHtml;
    }
}

function updatePlagiarismPanel(results) {
    const plagiarismConfidenceBar = document.getElementById('plagiarism-confidence-bar');
    const plagiarismConfidenceText = document.getElementById('plagiarism-confidence-text');
    const plagiarismFindings = document.getElementById('plagiarism-findings');
    
    if (results.plagiarism) {
        const similarity = results.plagiarism.similarity_score || 0;
        
        // Update confidence bar
        plagiarismConfidenceBar.style.width = similarity + '%';
        plagiarismConfidenceText.textContent = Math.round(similarity) + '%';
        
        // Set color based on similarity
        if (similarity > 70) {
            plagiarismConfidenceBar.className = 'confidence-fill high';
        } else if (similarity > 30) {
            plagiarismConfidenceBar.className = 'confidence-fill medium';
        } else {
            plagiarismConfidenceBar.className = 'confidence-fill low';
        }
        
        // Update findings
        let findingsHtml = '';
        if (results.plagiarism.sources) {
            results.plagiarism.sources.forEach(source => {
                findingsHtml += `<li><i class="fas fa-link"></i> ${source.url || source.title}: ${source.similarity}% match</li>`;
            });
        }
        plagiarismFindings.innerHTML = findingsHtml;
    }
}

function updateAuthenticityPanel(results) {
    const authenticityConfidenceBar = document.getElementById('authenticity-confidence-bar');
    const authenticityConfidenceText = document.getElementById('authenticity-confidence-text');
    const authenticityFindings = document.getElementById('authenticity-findings');
    
    if (results.authenticity) {
        const score = results.authenticity.score || 0;
        
        // Update confidence bar
        authenticityConfidenceBar.style.width = score + '%';
        authenticityConfidenceText.textContent = Math.round(score) + '%';
        
        // Set color based on score (high authenticity is good)
        if (score > 70) {
            authenticityConfidenceBar.className = 'confidence-fill low';
        } else if (score > 30) {
            authenticityConfidenceBar.className = 'confidence-fill medium';
        } else {
            authenticityConfidenceBar.className = 'confidence-fill high';
        }
        
        // Update findings
        let findingsHtml = '';
        if (results.authenticity.indicators) {
            results.authenticity.indicators.forEach(indicator => {
                findingsHtml += `<li><i class="fas fa-check"></i> ${indicator}</li>`;
            });
        }
        authenticityFindings.innerHTML = findingsHtml;
    }
}

function updateTechnicalPanel(results) {
    const technicalContent = document.getElementById('technical-content');
    
    let html = '<div class="key-findings"><h4>Technical Details</h4><ul>';
    
    if (results.metadata) {
        if (results.metadata.word_count) {
            html += `<li><i class="fas fa-file-word"></i> Word Count: ${results.metadata.word_count}</li>`;
        }
        if (results.metadata.character_count) {
            html += `<li><i class="fas fa-keyboard"></i> Character Count: ${results.metadata.character_count}</li>`;
        }
        if (results.metadata.processing_time) {
            html += `<li><i class="fas fa-clock"></i> Processing Time: ${results.metadata.processing_time}s</li>`;
        }
        if (results.metadata.analysis_timestamp) {
            html += `<li><i class="fas fa-calendar"></i> Analysis Date: ${new Date(results.metadata.analysis_timestamp).toLocaleString()}</li>`;
        }
    }
    
    html += '</ul></div>';
    
    technicalContent.innerHTML = html;
}

function showProgress() {
    const progressContainer = document.getElementById('progress-container');
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    progressContainer.style.display = 'block';
    
    // Hide results and errors
    document.getElementById('results-container').style.display = 'none';
    document.getElementById('error-container').style.display = 'none';
    
    // Animate progress
    let progress = 0;
    const steps = [
        'Initializing analysis...',
        'Processing content...',
        'Running AI detection...',
        'Checking for plagiarism...',
        'Generating comprehensive report...'
    ];
    
    progressInterval = setInterval(() => {
        progress += Math.random() * 15 + 5;
        if (progress > 90) progress = 90;
        
        progressFill.style.width = progress + '%';
        
        const stepIndex = Math.floor(progress / 20);
        if (stepIndex < steps.length) {
            progressText.textContent = steps[stepIndex];
            updateProgressSteps(stepIndex);
        }
    }, 800);
}

function updateProgressSteps(activeIndex) {
    const steps = document.querySelectorAll('.progress-step');
    steps.forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index < activeIndex) {
            step.classList.add('completed');
        } else if (index === activeIndex) {
            step.classList.add('active');
        }
    });
}

function completeProgress() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
    
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    
    progressFill.style.width = '100%';
    progressText.textContent = 'Analysis complete!';
    
    // Mark all steps as completed
    document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.remove('active');
        step.classList.add('completed');
    });
    
    // Hide progress after a delay
    setTimeout(() => {
        document.getElementById('progress-container').style.display = 'none';
    }, 1000);
}

function downloadReport(format) {
    if (!analysisResults) {
        alert('No analysis results available to download');
        return;
    }
    
    const endpoint = format === 'pdf' ? '/api/generate-unified-pdf' : '/api/generate-unified-report';
    
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            results: analysisResults,
            format: format
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Failed to generate report');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `unified-analysis-report-${new Date().toISOString().split('T')[0]}.${format === 'pdf' ? 'pdf' : 'html'}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(error => {
        console.error('Download error:', error);
        alert('Failed to download report. Please try again.');
    });
}

function retryAnalysis() {
    document.getElementById('error-container').style.display = 'none';
    startAnalysis(currentInputType);
}

function isValidUrl(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}
</script>
{% endblock %}
