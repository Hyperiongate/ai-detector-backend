{% extends "base.html" %}

{% block title %}AI News Intelligence System - Facts & Fakes{% endblock %}

{% block styles %}
<style>
    /* Enhanced color scheme with better contrast */
    :root {
        --primary-gradient: linear-gradient(135deg, #2563eb 0%, #6366f1 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        
        --card-bg: #ffffff;
        --section-bg: #f0f4f8;
        --accent-bg: #e0e7ff;
        --hover-bg: #ddd6fe;
        --border-strong: #c7d2fe;
        --text-primary: #1e293b;
        --text-secondary: #475569;
    }

    /* Main content wrapper */
    .main-content {
        background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%);
        min-height: 100vh;
    }

    /* Header styling */
    .news-header {
        background: var(--primary-gradient);
        color: white;
        padding: 60px 0;
        margin-bottom: -30px;
        position: relative;
        overflow: hidden;
    }

    .news-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="rgba(255,255,255,0.1)" d="M0,96L48,112C96,128,192,160,288,165.3C384,171,480,149,576,128C672,107,768,85,864,96C960,107,1056,149,1152,154.7C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') bottom no-repeat;
        background-size: cover;
    }

    .news-header .container {
        position: relative;
        z-index: 1;
    }

    .news-header h1 {
        font-size: 3.5em;
        font-weight: 900;
        margin-bottom: 15px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        animation: fadeInUp 0.8s ease-out;
    }

    .news-header p {
        font-size: 1.4em;
        opacity: 0.95;
        animation: fadeInUp 0.8s ease-out 0.2s;
        animation-fill-mode: both;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Container adjustments */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .content-wrapper {
        background: white;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        margin-top: -30px;
        position: relative;
        z-index: 10;
        padding: 40px;
    }

    /* Tech intro with gradient border */
    .tech-intro {
        background: linear-gradient(135deg, var(--accent-bg), var(--section-bg));
        border: 2px solid var(--border-strong);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 40px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }

    .tech-intro::before {
        content: '🚀';
        position: absolute;
        right: 30px;
        top: 30px;
        font-size: 60px;
        opacity: 0.1;
    }

    .tech-intro:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
        border-color: #6366f1;
    }

    .tech-intro h3 {
        color: #4f46e5;
        margin-bottom: 15px;
        font-size: 1.3em;
    }

    /* Input section with gradient accents */
    .input-section {
        background: white;
        border: 2px solid var(--border-strong);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 40px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        position: relative;
    }

    .input-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        border-radius: 16px 16px 0 0;
    }

    .input-tabs {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        justify-content: center;
    }

    .input-tab {
        padding: 12px 30px;
        border: 2px solid #e5e7eb;
        background: white;
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        border-radius: 12px;
        transition: all 0.3s;
        font-size: 16px;
    }

    .input-tab:hover {
        background: var(--accent-bg);
        border-color: #6366f1;
        color: #4f46e5;
        transform: translateY(-2px);
    }

    .input-tab.active {
        background: var(--primary-gradient);
        border-color: transparent;
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    /* Enhanced loading state */
    .loading {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 600px;
        padding: 40px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        z-index: 1000;
    }

    /* Results section */
    .results {
        display: none;
        animation: fadeIn 0.5s ease-out;
    }

    .results.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Compact Overall Summary */
    .overall-summary {
        background: white;
        border: 2px solid var(--border-strong);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        position: relative;
        overflow: hidden;
    }

    .overall-label {
        background: var(--primary-gradient);
        color: white;
        padding: 8px 20px;
        border-radius: 30px;
        display: inline-block;
        font-weight: 600;
        margin-bottom: 20px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 30px;
        align-items: center;
    }

    /* Enhanced trust score visualization */
    .trust-visual {
        text-align: center;
        position: relative;
    }

    .trust-meter {
        width: 250px;
        height: 250px;
        position: relative;
        margin: 0 auto;
    }

    .trust-meter svg {
        transform: rotate(-90deg);
        filter: drop-shadow(0 4px 15px rgba(0,0,0,0.1));
    }

    .trust-meter-bg {
        fill: none;
        stroke: #f3f4f6;
        stroke-width: 25;
    }

    .trust-meter-fill {
        fill: none;
        stroke-width: 25;
        stroke-linecap: round;
        transition: stroke-dashoffset 1.5s ease-in-out;
    }

    .trust-meter-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .trust-score-number {
        font-size: 64px;
        font-weight: 900;
        line-height: 1;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .trust-score-label {
        font-size: 18px;
        font-weight: 700;
        margin-top: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .trust-indicators {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }

    .trust-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #e5e7eb;
    }

    .trust-indicator.active {
        background: var(--primary-gradient);
    }

    /* Summary key points */
    .summary-content {
        flex: 1;
    }

    .summary-highlight {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border-left: 4px solid #f59e0b;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .summary-highlight h3 {
        color: #92400e;
        margin-bottom: 10px;
        font-size: 1.2em;
    }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
    }

    .stat-card {
        background: var(--section-bg);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        border: 1px solid var(--border-strong);
        transition: all 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-number {
        font-size: 32px;
        font-weight: 900;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .stat-label {
        font-size: 14px;
        color: var(--text-secondary);
        margin-top: 5px;
    }

    /* Compact dropdown styling */
    .analysis-dropdown {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        margin-bottom: 15px;
        overflow: hidden;
        transition: all 0.3s;
    }

    .analysis-dropdown:hover {
        border-color: var(--border-strong);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .analysis-dropdown.expanded {
        border-color: #6366f1;
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
    }

    /* Priority styling for Political Bias (first dropdown) */
    .analysis-dropdown.priority {
        border-color: #6366f1;
        background: linear-gradient(to right, #fef3c7 0%, white 100%);
    }

    .dropdown-header {
        padding: 20px 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        transition: all 0.3s;
    }

    .dropdown-header:hover {
        background: #fafafa;
    }

    .dropdown-icon-wrapper {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
    }

    .dropdown-icon {
        width: 40px;
        height: 40px;
        background: var(--primary-gradient);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
    }

    .dropdown-title-section {
        flex: 1;
    }

    .dropdown-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 3px;
    }

    .dropdown-preview {
        font-size: 13px;
        color: var(--text-secondary);
    }

    /* Enhanced Political Bias Visualization */
    .bias-visualization {
        background: linear-gradient(135deg, #eff6ff, #e0f2fe);
        border-radius: 16px;
        padding: 30px;
        margin: 20px 0;
        border: 1px solid #bfdbfe;
    }

    .bias-spectrum {
        position: relative;
        height: 80px;
        background: linear-gradient(to right, 
            #1e40af 0%, 
            #3b82f6 25%, 
            #a78bfa 50%, 
            #f87171 75%, 
            #dc2626 100%);
        border-radius: 40px;
        margin: 20px 0;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .bias-marker {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        border: 3px solid #1e293b;
    }

    .bias-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        font-weight: 600;
    }

    .bias-label {
        font-size: 14px;
        padding: 5px 10px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Author Credibility Infographic */
    .author-infographic {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        border-radius: 16px;
        padding: 30px;
        margin: 20px 0;
        border: 1px solid #86efac;
        text-align: center;
    }

    .author-avatar {
        width: 100px;
        height: 100px;
        background: var(--primary-gradient);
        border-radius: 50%;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        color: white;
        box-shadow: 0 5px 20px rgba(99, 102, 241, 0.3);
    }

    .author-details {
        margin-bottom: 20px;
    }

    .author-name {
        font-size: 24px;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 5px;
    }

    .author-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
    }

    .author-metric {
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .metric-icon {
        font-size: 24px;
        margin-bottom: 5px;
    }

    .metric-value {
        font-size: 20px;
        font-weight: 700;
        color: #059669;
    }

    .metric-label {
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* Fact Check Visualization */
    .fact-check-summary {
        background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        border-radius: 16px;
        padding: 25px;
        margin: 20px 0;
        border: 1px solid #7dd3fc;
    }

    .fact-check-chart {
        display: flex;
        justify-content: space-around;
        align-items: center;
        margin: 20px 0;
    }

    .fact-stat {
        text-align: center;
        position: relative;
    }

    .fact-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        font-weight: 900;
        color: white;
        margin: 0 auto 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .fact-circle.true {
        background: var(--success-gradient);
    }

    .fact-circle.false {
        background: var(--danger-gradient);
    }

    .fact-circle.unverified {
        background: var(--warning-gradient);
    }

    .fact-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
    }

    /* Expandable claims */
    .claims-list {
        margin-top: 20px;
    }

    .claim-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 10px;
        overflow: hidden;
    }

    .claim-header {
        padding: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background 0.3s;
    }

    .claim-header:hover {
        background: #fafafa;
    }

    .claim-status {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .claim-text {
        flex: 1;
        font-size: 14px;
    }

    .claim-details {
        padding: 0 15px 15px 55px;
        display: none;
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.6;
    }

    .claim-item.expanded .claim-details {
        display: block;
    }

    /* AI Insights with visual appeal */
    .ai-insights {
        background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
        border-radius: 16px;
        padding: 30px;
        margin: 20px 0;
        border: 1px solid #d8b4fe;
        position: relative;
        overflow: hidden;
    }

    .ai-insights::before {
        content: '🧠';
        position: absolute;
        right: 20px;
        top: 20px;
        font-size: 80px;
        opacity: 0.1;
    }

    .insight-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(147, 51, 234, 0.1);
        border-left: 4px solid #9333ea;
        position: relative;
    }

    .insight-number {
        position: absolute;
        left: -15px;
        top: 15px;
        width: 30px;
        height: 30px;
        background: var(--primary-gradient);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
    }

    .insight-content {
        margin-left: 10px;
    }

    .insight-title {
        font-weight: 700;
        color: #6b21a8;
        margin-bottom: 5px;
    }

    /* Enhanced warning signs */
    .warning-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin: 20px 0;
    }

    .warning-card {
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
        border: 1px solid #fecaca;
        border-radius: 12px;
        padding: 20px;
        position: relative;
        padding-left: 50px;
    }

    .warning-icon {
        position: absolute;
        left: 15px;
        top: 20px;
        font-size: 24px;
    }

    .warning-title {
        font-weight: 700;
        color: #991b1b;
        margin-bottom: 5px;
    }

    .warning-description {
        font-size: 13px;
        color: #7f1d1d;
        line-height: 1.5;
    }

    /* Action buttons */
    .action-section {
        text-align: center;
        margin-top: 40px;
        padding: 30px;
        background: var(--section-bg);
        border-radius: 16px;
    }

    .btn-pdf {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 18px 40px;
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-pdf:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }

    .btn-secondary {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 18px 40px;
        background: white;
        color: var(--text-primary);
        border: 2px solid var(--border-strong);
        border-radius: 12px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-left: 15px;
    }

    .btn-secondary:hover {
        background: var(--section-bg);
        transform: translateY(-3px);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }
        
        .summary-stats {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .fact-check-chart {
            flex-direction: column;
            gap: 20px;
        }
        
        .warning-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Include header -->
{% include 'includes/header.html' %}

<!-- Main content wrapper -->
<div class="main-content">
    <!-- Hero Header -->
    <div class="news-header">
        <div class="container">
            <h1>AI News Intelligence System</h1>
            <p>Advanced Neural Analysis Powered by GPT-4</p>
        </div>
    </div>

    <!-- Content wrapper with rounded top -->
    <div class="container">
        <div class="content-wrapper">
            <!-- Tech intro -->
            <div class="tech-intro" onclick="toggleTechIntro()">
                <h3>🚀 How Our Analysis Works - Click to Learn More</h3>
                <div class="tech-intro-content" style="display: none;">
                    <p style="margin-bottom: 20px;">Our system provides comprehensive news analysis using advanced AI technology:</p>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 15px;">🧠 <strong>GPT-4 Language Model:</strong> OpenAI's most sophisticated AI for understanding context and detecting bias</li>
                        <li style="margin-bottom: 15px;">📊 <strong>Statistical Analysis:</strong> Real-time counting of sources, quotes, and quality indicators</li>
                        <li style="margin-bottom: 15px;">🔍 <strong>Pattern Detection:</strong> Advanced algorithms to identify manipulation and missing context</li>
                        <li style="margin-bottom: 15px;">📈 <strong>Source Database:</strong> Comprehensive credibility ratings based on historical accuracy</li>
                    </ul>
                </div>
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <div class="input-tabs">
                    <button class="input-tab active" onclick="switchInputType('url')">🔗 URL Analysis</button>
                    <button class="input-tab" onclick="switchInputType('text')">📝 Text Analysis</button>
                </div>
                
                <div class="input-content active" id="urlInput">
                    <input type="url" 
                           id="articleUrl" 
                           placeholder="Enter news article URL..." 
                           class="url-input" 
                           style="width: 100%; padding: 18px 24px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px;">
                </div>
                
                <div class="input-content" id="textInput" style="display: none;">
                    <textarea id="articleText" 
                              placeholder="Paste article text here..."
                              style="width: 100%; min-height: 200px; padding: 18px 24px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px;"></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="analyze-btn" onclick="analyzeArticle()" 
                            style="padding: 18px 40px; background: linear-gradient(135deg, #2563eb, #6366f1); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer;">
                        🤖 ANALYZE ARTICLE
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loading">
                <div class="loading-content">
                    <div style="text-align: center;">
                        <div class="spinner" style="width: 60px; height: 60px; border: 4px solid #f3f4f6; border-top: 4px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        <p style="margin-top: 20px; font-size: 18px; color: var(--text-secondary);">Analyzing article with GPT-4...</p>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="results" id="results">
                <!-- Will be dynamically populated -->
            </div>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // State management
    let currentInputType = 'url';
    let currentAnalysisData = null;

    // Toggle functions
    window.toggleTechIntro = function() {
        const intro = document.querySelector('.tech-intro');
        const content = intro.querySelector('.tech-intro-content');
        
        if (content.style.display === 'none') {
            content.style.display = 'block';
            intro.style.background = 'linear-gradient(135deg, #ddd6fe, #e0e7ff)';
        } else {
            content.style.display = 'none';
            intro.style.background = 'linear-gradient(135deg, #e0e7ff, #f0f4f8)';
        }
    }

    window.switchInputType = function(type) {
        currentInputType = type;
        
        document.querySelectorAll('.input-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        document.querySelectorAll('.input-content').forEach(content => {
            content.style.display = 'none';
        });
        
        if (type === 'url') {
            document.getElementById('urlInput').style.display = 'block';
        } else {
            document.getElementById('textInput').style.display = 'block';
        }
    }

    // Main analysis function
    window.analyzeArticle = async function() {
        let content = '';
        let contentType = currentInputType;
        
        if (currentInputType === 'url') {
            content = document.getElementById('articleUrl').value.trim();
            if (!content) {
                showMessage('Please enter a valid URL', 'error');
                return;
            }
        } else {
            content = document.getElementById('articleText').value.trim();
            if (!content) {
                showMessage('Please enter article text', 'error');
                return;
            }
        }
        
        // Show loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').classList.remove('active');
        document.querySelector('.analyze-btn').disabled = true;
        
        try {
            const response = await fetch('/api/analyze-news', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: content,
                    type: contentType,
                    is_pro: true
                })
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Analysis failed');
            }
            
            currentAnalysisData = data;
            displayResults(data);
            
        } catch (error) {
            console.error('Analysis error:', error);
            showMessage(error.message, 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
            document.querySelector('.analyze-btn').disabled = false;
        }
    }

    // Display results with all enhancements
    function displayResults(data) {
        const results = data.results;
        const resultsDiv = document.getElementById('results');
        
        // Overall Summary with compact design
        const overallSummary = `
            <div class="overall-summary">
                <span class="overall-label">OVERALL ASSESSMENT</span>
                <div class="summary-grid">
                    <div class="trust-visual">
                        ${createEnhancedTrustMeter(results.credibility || 0)}
                    </div>
                    <div class="summary-content">
                        <div class="summary-highlight">
                            <h3>📋 Quick Summary</h3>
                            <p>${results.summary || 'Analysis complete. See detailed findings below.'}</p>
                        </div>
                        <div class="summary-stats">
                            <div class="stat-card">
                                <div class="stat-number">${results.sources?.credibility || 50}%</div>
                                <div class="stat-label">Source Credibility</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${results.bias?.objectivity || 50}%</div>
                                <div class="stat-label">Objectivity Score</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${results.overall_accuracy || 0}%</div>
                                <div class="stat-label">Fact Accuracy</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Generate dropdowns with Political Bias first
        const dropdowns = generateAllDropdowns(results);
        
        // Action buttons with PDF functionality
        const actions = `
            <div class="action-section">
                <button class="btn-pdf" onclick="generatePDF()">
                    📄 Save as PDF Report
                </button>
                <button class="btn-secondary" onclick="resetAnalysis()">
                    🔄 Analyze Another Article
                </button>
            </div>
        `;
        
        resultsDiv.innerHTML = overallSummary + dropdowns + actions;
        resultsDiv.classList.add('active');
        
        // Add interactivity
        initializeInteractions();
        
        // Animate trust meter
        setTimeout(() => animateTrustMeter(results.credibility || 0), 100);
    }

    function createEnhancedTrustMeter(score) {
        const color = score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#ef4444';
        const gradientId = `trustGradient${Date.now()}`;
        
        return `
            <div class="trust-meter">
                <svg width="250" height="250" viewBox="0 0 250 250">
                    <defs>
                        <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:${color};stop-opacity:1" />
                            <stop offset="100%" style="stop-color:${color};stop-opacity:0.7" />
                        </linearGradient>
                    </defs>
                    <circle cx="125" cy="125" r="110" class="trust-meter-bg"></circle>
                    <circle cx="125" cy="125" r="110" class="trust-meter-fill" 
                            stroke="url(#${gradientId})"
                            stroke-dasharray="691.15" 
                            stroke-dashoffset="691.15"></circle>
                </svg>
                <div class="trust-meter-center">
                    <div class="trust-score-number">${score}</div>
                    <div class="trust-score-label" style="color: ${color}">
                        ${score >= 80 ? 'RELIABLE' : score >= 60 ? 'MODERATE' : 'CAUTION'}
                    </div>
                </div>
            </div>
            <div class="trust-indicators">
                ${[...Array(5)].map((_, i) => 
                    `<div class="trust-indicator ${i < Math.floor(score/20) ? 'active' : ''}"></div>`
                ).join('')}
            </div>
        `;
    }

    function generateAllDropdowns(results) {
        const dropdowns = [];
        
        // 1. Political Bias - FIRST and PRIORITY
        if (results.bias) {
            dropdowns.push(`
                <div class="analysis-dropdown priority expanded">
                    <div class="dropdown-header">
                        <div class="dropdown-icon-wrapper">
                            <div class="dropdown-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">⚖️</div>
                            <div class="dropdown-title-section">
                                <div class="dropdown-title">Political Bias & Perspective Analysis</div>
                                <div class="dropdown-preview">${results.bias.label} - ${results.bias.objectivity}% objective</div>
                            </div>
                        </div>
                        <div class="expand-icon">▼</div>
                    </div>
                    <div class="dropdown-content" style="max-height: 2000px;">
                        <div class="dropdown-body">
                            ${createEnhancedBiasAnalysis(results.bias)}
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 2. Author Credibility with infographic
        if (results.author) {
            dropdowns.push(`
                <div class="analysis-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-icon-wrapper">
                            <div class="dropdown-icon" style="background: linear-gradient(135deg, #10b981, #059669);">👤</div>
                            <div class="dropdown-title-section">
                                <div class="dropdown-title">Author Credibility & Background</div>
                                <div class="dropdown-preview">${results.author !== 'Unknown' ? results.author : 'No author found'}</div>
                            </div>
                        </div>
                        <div class="expand-icon">▼</div>
                    </div>
                    <div class="dropdown-content">
                        <div class="dropdown-body">
                            ${createAuthorInfographic(results.author)}
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 3. Source Verification with enhanced visuals
        if (results.sources) {
            dropdowns.push(`
                <div class="analysis-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-icon-wrapper">
                            <div class="dropdown-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">🏛️</div>
                            <div class="dropdown-title-section">
                                <div class="dropdown-title">News Source Verification</div>
                                <div class="dropdown-preview">${results.sources.name} - ${results.sources.credibility}% credibility</div>
                            </div>
                        </div>
                        <div class="expand-icon">▼</div>
                    </div>
                    <div class="dropdown-content">
                        <div class="dropdown-body">
                            ${createSourceVerification(results.sources)}
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 4. Fact Checking with visual summary
        if (results.claims && results.claims.length > 0) {
            dropdowns.push(`
                <div class="analysis-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-icon-wrapper">
                            <div class="dropdown-icon" style="background: linear-gradient(135deg, #14b8a6, #0d9488);">✓</div>
                            <div class="dropdown-title-section">
                                <div class="dropdown-title">Fact-Checking Results</div>
                                <div class="dropdown-preview">${results.claims.length} claims analyzed</div>
                            </div>
                        </div>
                        <div class="expand-icon">▼</div>
                    </div>
                    <div class="dropdown-content">
                        <div class="dropdown-body">
                            ${createFactCheckVisualization(results.claims, results.overall_accuracy)}
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 5. AI Deep Insights with visual appeal
        if (results.key_findings && results.key_findings.length > 0) {
            dropdowns.push(`
                <div class="analysis-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-icon-wrapper">
                            <div class="dropdown-icon" style="background: linear-gradient(135deg, #8b5cf6, #a855f7);">🧠</div>
                            <div class="dropdown-title-section">
                                <div class="dropdown-title">AI Deep Insights</div>
                                <div class="dropdown-preview">${results.key_findings.length} key patterns detected</div>
                            </div>
                        </div>
                        <div class="expand-icon">▼</div>
                    </div>
                    <div class="dropdown-content">
                        <div class="dropdown-body">
                            ${createAIInsights(results.key_findings)}
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 6. Warning Signs with enhanced content
        if (results.red_flags && results.red_flags.length > 0) {
            dropdowns.push(`
                <div class="analysis-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-icon-wrapper">
                            <div class="dropdown-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">⚠️</div>
                            <div class="dropdown-title-section">
                                <div class="dropdown-title">Warning Signs & Red Flags</div>
                                <div class="dropdown-preview">${results.red_flags.length} issues identified</div>
                            </div>
                        </div>
                        <div class="expand-icon">▼</div>
                    </div>
                    <div class="dropdown-content">
                        <div class="dropdown-body">
                            ${createWarningSignsGrid(results.red_flags)}
                        </div>
                    </div>
                </div>
            `);
        }
        
        return dropdowns.join('');
    }

    function createEnhancedBiasAnalysis(bias) {
        return `
            <div class="bias-visualization">
                <h4 style="font-size: 20px; color: #1e293b; margin-bottom: 20px;">Political Perspective Analysis</h4>
                <p style="margin-bottom: 20px; line-height: 1.6;">
                    Our AI analyzed word choice, framing, source selection, and emotional language to determine political perspective.
                    This article shows <strong>${bias.label}</strong> characteristics with ${bias.objectivity}% objective reporting.
                </p>
                
                <div class="bias-spectrum">
                    <div class="bias-marker" style="left: ${50 + (bias.score * 5)}%;">
                        ${bias.score < -3 ? '←' : bias.score > 3 ? '→' : '•'}
                    </div>
                </div>
                
                <div class="bias-labels">
                    <span class="bias-label" style="color: #1e40af;">Far Left</span>
                    <span class="bias-label" style="color: #3b82f6;">Left</span>
                    <span class="bias-label" style="color: #a78bfa;">Center</span>
                    <span class="bias-label" style="color: #f87171;">Right</span>
                    <span class="bias-label" style="color: #dc2626;">Far Right</span>
                </div>
                
                ${bias.reasoning ? `
                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <h5 style="color: #6366f1; margin-bottom: 10px;">AI Analysis Details:</h5>
                    <p style="line-height: 1.6; color: #475569;">${bias.reasoning}</p>
                </div>` : ''}
                
                <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border-radius: 12px;">
                    <strong>What this means:</strong> ${
                        Math.abs(bias.score) <= 2 ? 'This article maintains relatively balanced reporting with minimal bias.' :
                        Math.abs(bias.score) <= 5 ? 'This article shows moderate bias. Consider reading perspectives from the other side.' :
                        'This article shows strong bias. Seek out multiple sources for a complete picture.'
                    }
                </div>
            </div>
        `;
    }

    function createAuthorInfographic(author) {
        const hasAuthor = author && author !== 'Unknown';
        
        return `
            <div class="author-infographic">
                <div class="author-avatar">
                    ${hasAuthor ? '👤' : '❓'}
                </div>
                <div class="author-details">
                    <div class="author-name">${hasAuthor ? author : 'Anonymous Author'}</div>
                    <div style="color: #64748b; margin-bottom: 10px;">
                        ${hasAuthor ? 'Author attribution found' : 'No author attribution provided'}
                    </div>
                </div>
                
                <div class="author-metrics">
                    <div class="author-metric">
                        <div class="metric-icon">✓</div>
                        <div class="metric-value">${hasAuthor ? 'Yes' : 'No'}</div>
                        <div class="metric-label">Attribution</div>
                    </div>
                    <div class="author-metric">
                        <div class="metric-icon">🏆</div>
                        <div class="metric-value">${hasAuthor ? '+20%' : '-20%'}</div>
                        <div class="metric-label">Trust Impact</div>
                    </div>
                    <div class="author-metric">
                        <div class="metric-icon">📊</div>
                        <div class="metric-value">${hasAuthor ? 'High' : 'Low'}</div>
                        <div class="metric-label">Accountability</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; text-align: left;">
                    <strong>Why author attribution matters:</strong>
                    <p style="margin-top: 10px; color: #64748b; line-height: 1.6;">
                        ${hasAuthor ? 
                        'Named authors take responsibility for their work and can be held accountable for accuracy. This transparency is a key indicator of journalistic integrity.' :
                        'Anonymous articles lack accountability. Without knowing who wrote it, we cannot verify expertise, check for conflicts of interest, or hold anyone responsible for false information.'}
                    </p>
                </div>
            </div>
        `;
    }

    function createSourceVerification(sources) {
        const credibilityColor = sources.credibility >= 80 ? '#10b981' : 
                                sources.credibility >= 60 ? '#f59e0b' : '#ef4444';
        
        return `
            <div style="background: linear-gradient(135deg, #eff6ff, #e0f2fe); padding: 30px; border-radius: 16px;">
                <h4 style="font-size: 20px; margin-bottom: 20px;">Source Credibility Analysis</h4>
                
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="font-size: 48px; font-weight: 900; color: ${credibilityColor};">
                        ${sources.credibility}%
                    </div>
                    <div style="font-size: 18px; color: #64748b;">Credibility Score</div>
                </div>
                
                <div style="display: grid; gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between;">
                        <span style="font-weight: 600;">Source Name:</span>
                        <span style="color: #6366f1;">${sources.name}</span>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between;">
                        <span style="font-weight: 600;">Domain:</span>
                        <span style="color: #6366f1;">${sources.domain}</span>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between;">
                        <span style="font-weight: 600;">Known Bias:</span>
                        <span style="color: #6366f1;">${sources.bias || 'Not detected'}</span>
                    </div>
                </div>
                
                ${sources.assessment ? `
                <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px;">
                    <strong>Assessment:</strong>
                    <p style="margin-top: 10px; line-height: 1.6; color: #475569;">${sources.assessment}</p>
                </div>` : ''}
            </div>
        `;
    }

    function createFactCheckVisualization(claims, overallAccuracy) {
        const trueCount = claims.filter(c => c.status.toLowerCase().includes('verif')).length;
        const falseCount = claims.filter(c => c.status.toLowerCase().includes('false')).length;
        const unverifiedCount = claims.length - trueCount - falseCount;
        
        return `
            <div class="fact-check-summary">
                <h4 style="font-size: 20px; margin-bottom: 20px;">Fact-Checking Summary</h4>
                
                <div class="fact-check-chart">
                    <div class="fact-stat">
                        <div class="fact-circle true">${trueCount}</div>
                        <div class="fact-label">Verified True</div>
                    </div>
                    <div class="fact-stat">
                        <div class="fact-circle false">${falseCount}</div>
                        <div class="fact-label">False/Misleading</div>
                    </div>
                    <div class="fact-stat">
                        <div class="fact-circle unverified">${unverifiedCount}</div>
                        <div class="fact-label">Unverified</div>
                    </div>
                </div>
                
                ${overallAccuracy ? `
                <div style="text-align: center; margin: 20px 0; padding: 20px; background: white; border-radius: 12px;">
                    <div style="font-size: 36px; font-weight: 900; color: ${overallAccuracy >= 80 ? '#10b981' : overallAccuracy >= 60 ? '#f59e0b' : '#ef4444'};">
                        ${overallAccuracy}%
                    </div>
                    <div style="color: #64748b;">Overall Factual Accuracy</div>
                </div>` : ''}
                
                <div class="claims-list">
                    <h5 style="margin-bottom: 15px;">Individual Claims Analysis:</h5>
                    ${claims.map((claim, i) => `
                        <div class="claim-item" data-index="${i}">
                            <div class="claim-header" onclick="toggleClaim(${i})">
                                <div class="claim-status" style="background: ${
                                    claim.status.toLowerCase().includes('verif') ? '#10b981' :
                                    claim.status.toLowerCase().includes('false') ? '#ef4444' : '#f59e0b'
                                }; color: white;">
                                    ${claim.status.toLowerCase().includes('verif') ? '✓' :
                                      claim.status.toLowerCase().includes('false') ? '✗' : '?'}
                                </div>
                                <div class="claim-text">${claim.claim}</div>
                                <div style="font-size: 12px; color: #64748b;">▼</div>
                            </div>
                            <div class="claim-details">
                                <strong>Status:</strong> ${claim.status}<br>
                                <strong>Confidence:</strong> ${claim.confidence}%<br>
                                ${claim.explanation ? `<strong>Explanation:</strong> ${claim.explanation}` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function createAIInsights(findings) {
        return `
            <div class="ai-insights">
                <h4 style="font-size: 20px; margin-bottom: 20px; position: relative; z-index: 1;">
                    🧠 AI-Powered Pattern Recognition
                </h4>
                <p style="margin-bottom: 20px; color: #6b21a8; position: relative; z-index: 1;">
                    Our AI identified these subtle patterns and insights that human readers might miss:
                </p>
                
                ${findings.map((finding, i) => `
                    <div class="insight-card">
                        <div class="insight-number">${i + 1}</div>
                        <div class="insight-content">
                            <div class="insight-title">Key Insight #${i + 1}</div>
                            <p style="margin-top: 8px; line-height: 1.6;">${finding}</p>
                        </div>
                    </div>
                `).join('')}
                
                <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; text-align: center;">
                    <strong style="color: #6b21a8;">Why AI insights matter:</strong>
                    <p style="margin-top: 10px; color: #64748b; line-height: 1.6;">
                        GPT-4 can detect manipulation tactics, missing context, logical fallacies, and emotional triggers 
                        that are designed to influence readers subconsciously.
                    </p>
                </div>
            </div>
        `;
    }

    function createWarningSignsGrid(redFlags) {
        const warningTypes = {
            'bias': { icon: '📊', title: 'Bias Indicator' },
            'source': { icon: '🔍', title: 'Source Issue' },
            'claim': { icon: '❌', title: 'False Claim' },
            'manipulation': { icon: '🎭', title: 'Manipulation' },
            'missing': { icon: '❓', title: 'Missing Info' },
            'emotion': { icon: '😤', title: 'Emotional' }
        };
        
        return `
            <div>
                <h4 style="font-size: 20px; margin-bottom: 20px;">Credibility Concerns Identified</h4>
                <div class="warning-grid">
                    ${redFlags.map(flag => {
                        const type = detectWarningType(flag);
                        const warning = warningTypes[type] || { icon: '⚠️', title: 'Warning' };
                        
                        return `
                            <div class="warning-card">
                                <div class="warning-icon">${warning.icon}</div>
                                <div>
                                    <div class="warning-title">${warning.title}</div>
                                    <div class="warning-description">${flag}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #fef2f2; border-radius: 12px; border: 1px solid #fecaca;">
                    <strong style="color: #991b1b;">What to do with these warnings:</strong>
                    <ul style="margin-top: 10px; margin-left: 20px; color: #7f1d1d;">
                        <li>Verify claims with multiple independent sources</li>
                        <li>Look for original documents or primary sources</li>
                        <li>Be aware of emotional manipulation tactics</li>
                        <li>Check if important context is missing</li>
                    </ul>
                </div>
            </div>
        `;
    }

    function detectWarningType(flag) {
        const lower = flag.toLowerCase();
        if (lower.includes('bias') || lower.includes('lean')) return 'bias';
        if (lower.includes('source') || lower.includes('credib')) return 'source';
        if (lower.includes('false') || lower.includes('incorrect')) return 'claim';
        if (lower.includes('manipul') || lower.includes('mislead')) return 'manipulation';
        if (lower.includes('missing') || lower.includes('omit')) return 'missing';
        if (lower.includes('emotion') || lower.includes('fear')) return 'emotion';
        return 'general';
    }

    // Initialize interactions
    function initializeInteractions() {
        // Toggle dropdowns
        document.querySelectorAll('.dropdown-header').forEach(header => {
            header.addEventListener('click', function() {
                const dropdown = this.closest('.analysis-dropdown');
                const content = dropdown.querySelector('.dropdown-content');
                const icon = this.querySelector('.expand-icon');
                
                if (dropdown.classList.contains('expanded')) {
                    dropdown.classList.remove('expanded');
                    content.style.maxHeight = '0';
                    icon.textContent = '▼';
                } else {
                    dropdown.classList.add('expanded');
                    content.style.maxHeight = '2000px';
                    icon.textContent = '▲';
                }
            });
        });
    }

    // Toggle individual claims
    window.toggleClaim = function(index) {
        const claim = document.querySelector(`.claim-item[data-index="${index}"]`);
        claim.classList.toggle('expanded');
    }

    // Animate trust meter
    function animateTrustMeter(score) {
        const circle = document.querySelector('.trust-meter-fill');
        if (circle) {
            const circumference = 691.15;
            const offset = circumference - (score / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }
    }

    // PDF Generation
    window.generatePDF = async function() {
        if (!currentAnalysisData) {
            showMessage('No analysis to save', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/generate-pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    analysis_data: currentAnalysisData.results,
                    article_url: document.getElementById('articleUrl').value || 'Text Analysis'
                })
            });
            
            if (!response.ok) throw new Error('PDF generation failed');
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `news-analysis-${Date.now()}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showMessage('PDF report generated successfully!', 'success');
        } catch (error) {
            console.error('PDF generation error:', error);
            showMessage('Failed to generate PDF report', 'error');
        }
    }

    // Reset analysis
    window.resetAnalysis = function() {
        document.getElementById('articleUrl').value = '';
        document.getElementById('articleText').value = '';
        document.getElementById('results').classList.remove('active');
        currentAnalysisData = null;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Show messages
    function showMessage(text, type) {
        const message = document.createElement('div');
        message.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: ${type === 'error' ? '#fee2e2' : '#dcfce7'};
            color: ${type === 'error' ? '#991b1b' : '#166534'};
            border: 1px solid ${type === 'error' ? '#fecaca' : '#bbf7d0'};
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 9999;
        `;
        message.textContent = text;
        document.body.appendChild(message);
        
        setTimeout(() => {
            message.remove();
        }, 5000);
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('AI News Intelligence System initialized');
    });
</script>
{% endblock %}
