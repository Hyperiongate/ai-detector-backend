{% extends "base.html" %}

{% block title %}AI News Intelligence System - Facts & Fakes{% endblock %}

{% block styles %}
<style>
    /* Enhanced color scheme */
    :root {
        --primary-gradient: linear-gradient(135deg, #2563eb 0%, #6366f1 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        
        --card-bg: #ffffff;
        --section-bg: #f0f4f8;
        --accent-bg: #e0e7ff;
        --hover-bg: #ddd6fe;
        --border-strong: #c7d2fe;
        --text-primary: #1e293b;
        --text-secondary: #475569;
    }

    /* Main content wrapper */
    .main-content {
        background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%);
        min-height: 100vh;
    }

    /* Header styling */
    .news-header {
        background: var(--primary-gradient);
        color: white;
        padding: 60px 0;
        margin-bottom: -30px;
        position: relative;
        overflow: hidden;
    }

    .news-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="rgba(255,255,255,0.1)" d="M0,96L48,112C96,128,192,160,288,165.3C384,171,480,149,576,128C672,107,768,85,864,96C960,107,1056,149,1152,154.7C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') bottom no-repeat;
        background-size: cover;
    }

    .news-header .container {
        position: relative;
        z-index: 1;
    }

    .news-header h1 {
        font-size: 3.5em;
        font-weight: 900;
        margin-bottom: 15px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        animation: fadeInUp 0.8s ease-out;
    }

    .news-header p {
        font-size: 1.4em;
        opacity: 0.95;
        animation: fadeInUp 0.8s ease-out 0.2s;
        animation-fill-mode: both;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Container adjustments */
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .content-wrapper {
        background: white;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        margin-top: -30px;
        position: relative;
        z-index: 10;
        padding: 40px;
    }

    /* Compact pricing info */
    .pricing-info {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border: 1px solid #fbbf24;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .pricing-info:hover {
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);
    }

    .pricing-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pricing-header h3 {
        color: #92400e;
        font-size: 1.1em;
        margin: 0;
    }

    .pricing-content {
        display: none;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #fcd34d;
    }

    .pricing-content.show {
        display: block;
    }

    .pricing-tier {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
    }

    /* Input section */
    .input-section {
        background: white;
        border: 2px solid var(--border-strong);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 40px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        position: relative;
    }

    .input-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        border-radius: 16px 16px 0 0;
    }

    /* Loading state */
    .loading {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 600px;
        padding: 40px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        z-index: 1000;
    }

    /* Results section */
    .results {
        display: none;
        animation: fadeIn 0.5s ease-out;
    }

    .results.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Compact Overall Summary */
    .overall-summary {
        background: white;
        border: 2px solid var(--border-strong);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        position: relative;
        overflow: hidden;
    }

    .overall-label {
        background: var(--primary-gradient);
        color: white;
        padding: 8px 20px;
        border-radius: 30px;
        display: inline-block;
        font-weight: 600;
        margin-bottom: 20px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 30px;
        align-items: start;
    }

    /* Enhanced trust score visualization */
    .trust-visual {
        text-align: center;
        position: relative;
    }

    .trust-meter {
        width: 250px;
        height: 250px;
        position: relative;
        margin: 0 auto;
    }

    .trust-meter svg {
        transform: rotate(-90deg);
        filter: drop-shadow(0 4px 15px rgba(0,0,0,0.1));
    }

    .trust-meter-bg {
        fill: none;
        stroke: #f3f4f6;
        stroke-width: 25;
    }

    .trust-meter-fill {
        fill: none;
        stroke-width: 25;
        stroke-linecap: round;
        transition: stroke-dashoffset 1.5s ease-in-out;
    }

    .trust-meter-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .trust-score-number {
        font-size: 64px;
        font-weight: 900;
        line-height: 1;
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .trust-score-label {
        font-size: 18px;
        font-weight: 700;
        margin-top: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .trust-explanation {
        margin-top: 15px;
        padding: 15px;
        background: var(--section-bg);
        border-radius: 12px;
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    /* Summary content sections */
    .summary-content {
        flex: 1;
    }

    .summary-section {
        background: var(--section-bg);
        border-left: 4px solid #3b82f6;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .summary-section h4 {
        color: #1e40af;
        font-size: 1.1em;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .summary-section p {
        margin: 5px 0;
        color: var(--text-secondary);
    }

    .summary-section strong {
        color: var(--text-primary);
    }

    /* Compact dropdown styling */
    .analysis-dropdown {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        margin-bottom: 15px;
        overflow: hidden;
        transition: all 0.3s;
    }

    .analysis-dropdown:hover {
        border-color: var(--border-strong);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .analysis-dropdown.expanded {
        border-color: #6366f1;
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
    }

    /* Priority styling for Political Bias */
    .analysis-dropdown.priority {
        border-color: #6366f1;
        background: linear-gradient(to right, #fef3c7 0%, white 100%);
    }

    .dropdown-header {
        padding: 20px 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        transition: all 0.3s;
    }

    .dropdown-header:hover {
        background: #fafafa;
    }

    .dropdown-icon-wrapper {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
    }

    .dropdown-icon {
        width: 40px;
        height: 40px;
        background: var(--primary-gradient);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
    }

    /* Enhanced Political Bias Visualization */
    .bias-visualization {
        background: linear-gradient(135deg, #eff6ff, #e0f2fe);
        border-radius: 16px;
        padding: 30px;
        margin: 20px 0;
        border: 1px solid #bfdbfe;
    }

    .bias-spectrum {
        position: relative;
        height: 40px;
        background: linear-gradient(to right, 
            #1e40af 0%, 
            #3b82f6 20%,
            #10b981 40%,
            #10b981 60%,
            #f87171 80%,
            #dc2626 100%);
        border-radius: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    .bias-marker {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        border: 3px solid #1e293b;
    }

    .bias-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        font-weight: 600;
    }

    .bias-label {
        font-size: 12px;
        padding: 4px 8px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Author Credibility Visualization */
    .author-infographic {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        border-radius: 16px;
        padding: 30px;
        margin: 20px 0;
        border: 1px solid #86efac;
    }

    .author-trust-bar {
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .trust-bar-container {
        background: #e5e7eb;
        height: 30px;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

    .trust-bar-fill {
        height: 100%;
        background: var(--success-gradient);
        transition: width 1s ease-out;
        position: relative;
    }

    .trust-bar-label {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-weight: 600;
        font-size: 14px;
    }

    .author-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 20px;
    }

    .author-metric {
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        text-align: center;
    }

    /* Source Credibility with explanation */
    .credibility-scale {
        margin: 20px 0;
        padding: 20px;
        background: white;
        border-radius: 12px;
    }

    .scale-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .scale-score {
        font-size: 36px;
        font-weight: 900;
    }

    .scale-bars {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
    }

    .scale-bar {
        height: 40px;
        flex: 1;
        background: #e5e7eb;
        position: relative;
        overflow: hidden;
    }

    .scale-bar.filled {
        background: var(--success-gradient);
    }

    .scale-bar:first-child {
        border-radius: 8px 0 0 8px;
    }

    .scale-bar:last-child {
        border-radius: 0 8px 8px 0;
    }

    .scale-explanation {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.5;
        margin-top: 15px;
        padding: 15px;
        background: var(--section-bg);
        border-radius: 8px;
    }

    /* Enhanced AI Insights */
    .ai-insights {
        background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
        border-radius: 16px;
        padding: 30px;
        margin: 20px 0;
        border: 1px solid #d8b4fe;
        position: relative;
    }

    .insight-category {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(147, 51, 234, 0.1);
    }

    .insight-category h5 {
        color: #6b21a8;
        margin-bottom: 10px;
        font-size: 1.1em;
    }

    .insight-finding {
        padding: 10px 0;
        border-bottom: 1px solid #f3e8ff;
        color: var(--text-secondary);
        line-height: 1.6;
    }

    .insight-finding:last-child {
        border-bottom: none;
    }

    .insight-finding strong {
        color: #6b21a8;
    }

    /* Action buttons */
    .action-section {
        text-align: center;
        margin-top: 40px;
        padding: 30px;
        background: var(--section-bg);
        border-radius: 16px;
    }

    .btn-pdf {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 18px 40px;
        background: var(--primary-gradient);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-pdf:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
    }

    .btn-pdf:disabled {
        background: #94a3b8;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }
        
        .author-metrics {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Include header -->
{% include 'includes/header.html' %}

<!-- Main content wrapper -->
<div class="main-content">
    <!-- Hero Header -->
    <div class="news-header">
        <div class="container">
            <h1>AI News Intelligence System</h1>
            <p>Advanced Neural Analysis Powered by GPT-4</p>
        </div>
    </div>

    <!-- Content wrapper -->
    <div class="container">
        <div class="content-wrapper">
            <!-- Compact pricing info -->
            <div class="pricing-info" onclick="togglePricing()">
                <div class="pricing-header">
                    <h3>📊 Analysis Limits & Pricing</h3>
                    <span style="color: #92400e;">▼</span>
                </div>
                <div class="pricing-content" id="pricingContent">
                    <div class="pricing-tier">
                        <div>
                            <strong>Free Tier</strong><br>
                            <span style="font-size: 14px; color: #92400e;">Basic analysis • 1 article per day</span>
                        </div>
                        <span style="color: #92400e; font-weight: 600;">$0</span>
                    </div>
                    <div class="pricing-tier">
                        <div>
                            <strong>Pro Tier</strong><br>
                            <span style="font-size: 14px; color: #92400e;">Full analysis • Unlimited articles • Priority support</span>
                        </div>
                        <span style="color: #92400e; font-weight: 600;">$9.99/mo</span>
                    </div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="input-section">
                <div class="input-tabs" style="display: flex; gap: 15px; margin-bottom: 25px; justify-content: center;">
                    <button class="input-tab active" onclick="switchInputType('url')" 
                            style="padding: 12px 30px; border: 2px solid #e5e7eb; background: linear-gradient(135deg, #2563eb, #6366f1); color: white; font-weight: 600; cursor: pointer; border-radius: 12px; font-size: 16px;">
                        🔗 URL Analysis
                    </button>
                    <button class="input-tab" onclick="switchInputType('text')"
                            style="padding: 12px 30px; border: 2px solid #e5e7eb; background: white; color: #475569; font-weight: 600; cursor: pointer; border-radius: 12px; font-size: 16px;">
                        📝 Text Analysis
                    </button>
                </div>
                
                <div class="input-content active" id="urlInput">
                    <input type="url" 
                           id="articleUrl" 
                           placeholder="Enter news article URL..." 
                           style="width: 100%; padding: 18px 24px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px;">
                </div>
                
                <div class="input-content" id="textInput" style="display: none;">
                    <textarea id="articleText" 
                              placeholder="Paste article text here..."
                              style="width: 100%; min-height: 200px; padding: 18px 24px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; resize: vertical;"></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="analyze-btn" onclick="analyzeArticle()" 
                            style="padding: 18px 40px; background: linear-gradient(135deg, #2563eb, #6366f1); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); transition: all 0.3s;">
                        🤖 ANALYZE ARTICLE
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loading">
                <div style="text-align: center;">
                    <div style="width: 60px; height: 60px; border: 4px solid #f3f4f6; border-top: 4px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <p style="margin-top: 20px; font-size: 18px; color: #475569;">Analyzing article with GPT-4...</p>
                </div>
            </div>

            <!-- Results -->
            <div class="results" id="results">
                <!-- Will be dynamically populated -->
            </div>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    // State management
    let currentInputType = 'url';
    let currentAnalysisData = null;

    // Toggle pricing info
    window.togglePricing = function() {
        const content = document.getElementById('pricingContent');
        const icon = document.querySelector('.pricing-header span');
        
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            icon.textContent = '▼';
        } else {
            content.classList.add('show');
            icon.textContent = '▲';
        }
    }

    window.switchInputType = function(type) {
        currentInputType = type;
        
        document.querySelectorAll('.input-tab').forEach(tab => {
            tab.style.background = 'white';
            tab.style.color = '#475569';
        });
        
        event.target.style.background = 'linear-gradient(135deg, #2563eb, #6366f1)';
        event.target.style.color = 'white';
        
        document.querySelectorAll('.input-content').forEach(content => {
            content.style.display = 'none';
        });
        
        if (type === 'url') {
            document.getElementById('urlInput').style.display = 'block';
        } else {
            document.getElementById('textInput').style.display = 'block';
        }
    }

    // Main analysis function
    window.analyzeArticle = async function() {
        let content = '';
        
        if (currentInputType === 'url') {
            content = document.getElementById('articleUrl').value.trim();
            if (!content) {
                showMessage('Please enter a valid URL', 'error');
                return;
            }
        } else {
            content = document.getElementById('articleText').value.trim();
            if (!content) {
                showMessage('Please enter article text', 'error');
                return;
            }
        }
        
        // Show loading
        document.getElementById('loading').style.display = 'block';
        document.getElementById('results').classList.remove('active');
        document.querySelector('.analyze-btn').disabled = true;
        
        try {
            const response = await fetch('/api/analyze-news', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: content,
                    type: currentInputType,
                    is_pro: true
                })
            });
            
            const data = await response.json();
            
            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Analysis failed');
            }
            
            currentAnalysisData = data;
            displayResults(data);
            
        } catch (error) {
            console.error('Analysis error:', error);
            showMessage(error.message, 'error');
        } finally {
            document.getElementById('loading').style.display = 'none';
            document.querySelector('.analyze-btn').disabled = false;
        }
    }

    // Display results
    function displayResults(data) {
        const results = data.results;
        const resultsDiv = document.getElementById('results');
        
        // Overall Summary with required elements
        const overallSummary = `
            <div class="overall-summary">
                <span class="overall-label">OVERALL ASSESSMENT</span>
                <div class="summary-grid">
                    <div class="trust-visual">
                        ${createEnhancedTrustMeter(results.credibility || 0)}
                    </div>
                    <div class="summary-content">
                        <!-- Source and Author -->
                        <div class="summary-section">
                            <h4>📰 Source & Author</h4>
                            <p><strong>Source:</strong> ${results.sources?.name || 'Unknown'}</p>
                            <p><strong>Author:</strong> ${results.author && results.author !== 'Unknown' ? results.author : 'No author listed'}</p>
                        </div>
                        
                        <!-- Article Summary -->
                        <div class="summary-section">
                            <h4>📋 Article Summary</h4>
                            <p>${results.summary || 'This article discusses current events and news topics. See detailed analysis below for specific findings.'}</p>
                        </div>
                        
                        <!-- Key Findings -->
                        <div class="summary-section">
                            <h4>🔍 Key Findings</h4>
                            ${generateCompactFindings(results)}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Generate dropdowns with Political Bias first
        const dropdowns = generateAllDropdowns(results);
        
        // Action buttons
        const actions = `
            <div class="action-section">
                <button class="btn-pdf" id="pdfButton" onclick="generatePDF()">
                    📄 Save as PDF Report
                </button>
                <button class="btn-secondary" onclick="resetAnalysis()" style="display: inline-flex; align-items: center; gap: 10px; padding: 18px 40px; background: white; color: #1e293b; border: 2px solid #c7d2fe; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; margin-left: 15px;">
                    🔄 Analyze Another Article
                </button>
            </div>
        `;
        
        resultsDiv.innerHTML = overallSummary + dropdowns + actions;
        resultsDiv.classList.add('active');
        
        // Initialize interactions
        initializeInteractions();
        
        // Animate trust meter
        setTimeout(() => animateTrustMeter(results.credibility || 0), 100);
    }

    function createEnhancedTrustMeter(score) {
        const color = score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#ef4444';
        const label = score >= 80 ? 'RELIABLE' : score >= 60 ? 'MODERATE' : 'CAUTION';
        const meaning = score >= 80 ? 'This source is highly trustworthy with consistent accurate reporting' : 
                       score >= 60 ? 'This source has moderate reliability - verify important claims' : 
                       'This source has low credibility - seek additional sources';
        
        return `
            <div class="trust-meter">
                <svg width="250" height="250" viewBox="0 0 250 250">
                    <circle cx="125" cy="125" r="110" class="trust-meter-bg"></circle>
                    <circle cx="125" cy="125" r="110" class="trust-meter-fill" 
                            stroke="${color}"
                            stroke-dasharray="691.15" 
                            stroke-dashoffset="691.15"></circle>
                </svg>
                <div class="trust-meter-center">
                    <div class="trust-score-number">${score}</div>
                    <div class="trust-score-label" style="color: ${color};">${label}</div>
                </div>
            </div>
            <div class="trust-explanation">
                <strong>Overall Trust Score: ${score}%</strong><br>
                ${meaning}
            </div>
        `;
    }

    function generateCompactFindings(results) {
        const findings = [];
        
        if (results.sources?.credibility >= 80) {
            findings.push('✅ Highly credible news source');
        } else if (results.sources?.credibility >= 60) {
            findings.push('⚠️ Moderately credible source');
        } else {
            findings.push('❌ Low credibility source');
        }
        
        if (results.bias?.objectivity >= 80) {
            findings.push('✅ Objective reporting detected');
        } else {
            findings.push(`📊 ${results.bias?.label || 'Biased'} perspective detected`);
        }
        
        if (results.overall_accuracy >= 80) {
            findings.push('✅ High factual accuracy');
        } else if (results.overall_accuracy >= 60) {
            findings.push('⚠️ Moderate factual accuracy');
        }
        
        return findings.map(f => `<p style="margin: 5px 0;">${f}</p>`).join('');
    }

    function generateAllDropdowns(results) {
        const dropdowns = [];
        
        // 1. Political Bias - FIRST and expanded
        if (results.bias) {
            dropdowns.push(`
                <div class="analysis-dropdown priority expanded">
                    <div class="dropdown-header">
                        <div class="dropdown-icon-wrapper">
                            <div class="dropdown-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">⚖️</div>
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: 700; color: #1e293b;">Political Bias & Perspective Analysis</div>
                                <div style="font-size: 13px; color: #64748b;">${results.bias.label} - ${results.bias.objectivity}% objective</div>
                            </div>
                        </div>
                        <div style="font-size: 20px; color: #64748b; transition: transform 0.3s;">▲</div>
                    </div>
                    <div class="dropdown-content" style="max-height: 2000px;">
                        <div style="padding: 25px;">
                            ${createEnhancedBiasAnalysis(results.bias)}
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 2. Author Credibility
        if (results.author) {
            dropdowns.push(`
                <div class="analysis-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-icon-wrapper">
                            <div class="dropdown-icon" style="background: linear-gradient(135deg, #10b981, #059669);">👤</div>
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: 700; color: #1e293b;">Author Credibility & Background</div>
                                <div style="font-size: 13px; color: #64748b;">${results.author !== 'Unknown' ? results.author : 'No author found'}</div>
                            </div>
                        </div>
                        <div class="expand-icon" style="font-size: 20px; color: #64748b;">▼</div>
                    </div>
                    <div class="dropdown-content">
                        <div style="padding: 25px;">
                            ${createAuthorCredibility(results.author)}
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 3. Source Verification
        if (results.sources) {
            dropdowns.push(`
                <div class="analysis-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-icon-wrapper">
                            <div class="dropdown-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">🏛️</div>
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: 700; color: #1e293b;">News Source Verification</div>
                                <div style="font-size: 13px; color: #64748b;">${results.sources.name} - ${results.sources.credibility}% credibility</div>
                            </div>
                        </div>
                        <div class="expand-icon" style="font-size: 20px; color: #64748b;">▼</div>
                    </div>
                    <div class="dropdown-content">
                        <div style="padding: 25px;">
                            ${createSourceCredibility(results.sources)}
                        </div>
                    </div>
                </div>
            `);
        }
        
        // 4. AI Deep Insights - Enhanced
        if (results.key_findings && results.key_findings.length > 0) {
            dropdowns.push(`
                <div class="analysis-dropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-icon-wrapper">
                            <div class="dropdown-icon" style="background: linear-gradient(135deg, #8b5cf6, #a855f7);">🧠</div>
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: 700; color: #1e293b;">AI Deep Insights - What Others Might Miss</div>
                                <div style="font-size: 13px; color: #64748b;">${results.key_findings.length} hidden patterns detected</div>
                            </div>
                        </div>
                        <div class="expand-icon" style="font-size: 20px; color: #64748b;">▼</div>
                    </div>
                    <div class="dropdown-content">
                        <div style="padding: 25px;">
                            ${createEnhancedAIInsights(results.key_findings)}
                        </div>
                    </div>
                </div>
            `);
        }
        
        return dropdowns.join('');
    }

    function createEnhancedBiasAnalysis(bias) {
        const biasEvidence = bias.reasoning || 'Our AI detected subtle language patterns and framing that indicate political perspective.';
        
        return `
            <div class="bias-visualization">
                <h4 style="font-size: 20px; color: #1e293b; margin-bottom: 20px;">Political Perspective Analysis</h4>
                
                <div class="bias-spectrum">
                    <div class="bias-marker" style="left: ${50 + (bias.score * 5)}%;">
                        ${bias.score < -3 ? '◀' : bias.score > 3 ? '▶' : '●'}
                    </div>
                </div>
                
                <div class="bias-labels">
                    <span class="bias-label" style="color: #1e40af;">Far Left</span>
                    <span class="bias-label" style="color: #3b82f6;">Left</span>
                    <span class="bias-label" style="color: #10b981;">Center</span>
                    <span class="bias-label" style="color: #f87171;">Right</span>
                    <span class="bias-label" style="color: #dc2626;">Far Right</span>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <h5 style="color: #6366f1; margin-bottom: 10px;">Evidence of Bias:</h5>
                    <p style="line-height: 1.6; color: #475569;">${biasEvidence}</p>
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border-radius: 12px;">
                    <strong>What this means:</strong><br>
                    <span style="color: #92400e;">
                    ${Math.abs(bias.score) <= 2 ? 
                        'This article maintains relatively balanced reporting. The slight lean detected is within normal journalistic variance.' :
                      Math.abs(bias.score) <= 5 ? 
                        `This article shows moderate ${bias.label} bias. Key facts may be accurate but pay attention to what perspectives are emphasized or omitted.` :
                        `This article shows strong ${bias.label} bias. Facts may be cherry-picked to support a particular narrative. Seek alternative viewpoints.`}
                    </span>
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #e0e7ff; border-radius: 12px;">
                    <strong>How we detected this:</strong><br>
                    <ul style="margin-top: 10px; margin-left: 20px; color: #4f46e5;">
                        <li>Word choice and emotional language analysis</li>
                        <li>Source selection patterns (who is quoted)</li>
                        <li>Story framing and emphasis</li>
                        <li>Missing perspectives or context</li>
                        <li>Comparison to known bias patterns</li>
                    </ul>
                </div>
            </div>
        `;
    }

    function createAuthorCredibility(author) {
        const hasAuthor = author && author !== 'Unknown';
        const trustLevel = hasAuthor ? 80 : 20;
        
        return `
            <div class="author-infographic">
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="width: 100px; height: 100px; background: ${hasAuthor ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #ef4444, #dc2626)'}; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 48px; color: white; box-shadow: 0 5px 20px rgba(0,0,0,0.2);">
                        ${hasAuthor ? '👤' : '❓'}
                    </div>
                    <div style="font-size: 24px; font-weight: 800; color: #1e293b; margin-bottom: 5px;">
                        ${hasAuthor ? author : 'Anonymous Author'}
                    </div>
                    ${hasAuthor && author.includes('@') ? 
                        `<a href="https://twitter.com/${author.replace('@', '')}" target="_blank" style="color: #3b82f6; text-decoration: none;">View Twitter Profile →</a>` : ''}
                </div>
                
                <div class="author-trust-bar">
                    <h5 style="margin-bottom: 15px;">Author Trust Impact</h5>
                    <div class="trust-bar-container">
                        <div class="trust-bar-fill" style="width: ${trustLevel}%;">
                            <span class="trust-bar-label">${trustLevel}% Trust</span>
                        </div>
                    </div>
                    <p style="margin-top: 15px; font-size: 14px; color: #64748b; line-height: 1.5;">
                        ${hasAuthor ? 
                            'Named authors increase article credibility by 80%. They can be held accountable for accuracy and readers can verify their expertise.' :
                            'Anonymous articles reduce credibility by 80%. Without author attribution, we cannot verify expertise or check for conflicts of interest.'}
                    </p>
                </div>
                
                <div class="author-metrics">
                    <div class="author-metric">
                        <div style="font-size: 24px; margin-bottom: 5px;">✓</div>
                        <div style="font-size: 18px; font-weight: 700; color: ${hasAuthor ? '#10b981' : '#ef4444'};">
                            ${hasAuthor ? 'Named' : 'Anonymous'}
                        </div>
                        <div style="font-size: 12px; color: #64748b;">Attribution</div>
                    </div>
                    <div class="author-metric">
                        <div style="font-size: 24px; margin-bottom: 5px;">📊</div>
                        <div style="font-size: 18px; font-weight: 700; color: ${hasAuthor ? '#10b981' : '#ef4444'};">
                            ${hasAuthor ? 'High' : 'Low'}
                        </div>
                        <div style="font-size: 12px; color: #64748b;">Accountability</div>
                    </div>
                    <div class="author-metric">
                        <div style="font-size: 24px; margin-bottom: 5px;">🔍</div>
                        <div style="font-size: 18px; font-weight: 700; color: ${hasAuthor ? '#10b981' : '#ef4444'};">
                            ${hasAuthor ? 'Verifiable' : 'Unverifiable'}
                        </div>
                        <div style="font-size: 12px; color: #64748b;">Background</div>
                    </div>
                </div>
            </div>
        `;
    }

    function createSourceCredibility(sources) {
        const score = sources.credibility || 50;
        const filledBars = Math.round(score / 20);
        
        return `
            <div class="credibility-scale">
                <div class="scale-header">
                    <div>
                        <h4 style="margin: 0; color: #1e293b;">Source Credibility Score</h4>
                        <p style="margin: 5px 0 0 0; color: #64748b; font-size: 14px;">${sources.name}</p>
                    </div>
                    <div class="scale-score" style="color: ${score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#ef4444'};">
                        ${score}%
                    </div>
                </div>
                
                <div class="scale-bars">
                    ${[...Array(5)].map((_, i) => 
                        `<div class="scale-bar ${i < filledBars ? 'filled' : ''}"></div>`
                    ).join('')}
                </div>
                
                <div class="scale-explanation">
                    <strong>What ${score}% credibility means:</strong><br>
                    ${score >= 80 ? 
                        'This is an highly credible source with excellent journalistic standards. They consistently publish accurate information, issue corrections when needed, and maintain editorial independence.' :
                      score >= 60 ?
                        'This source has moderate credibility. While generally reliable, they may occasionally publish inaccurate information or show some bias. Cross-check important claims.' :
                        'This source has low credibility. They frequently publish misleading or false information, lack editorial standards, or have strong political bias. Verify all claims independently.'}
                </div>
                
                <div style="margin-top: 20px; padding: 20px; background: #eff6ff; border-radius: 12px;">
                    <h5 style="color: #1e40af; margin-bottom: 10px;">How we calculate credibility:</h5>
                    <ul style="margin-left: 20px; color: #3b82f6; line-height: 1.8;">
                        <li>Historical accuracy of reporting</li>
                        <li>Transparency about ownership and funding</li>
                        <li>Quality of correction policies</li>
                        <li>Adherence to journalistic ethics</li>
                        <li>Recognition by journalism organizations</li>
                    </ul>
                </div>
            </div>
        `;
    }

    function createEnhancedAIInsights(findings) {
        // Categorize insights
        const manipulationInsights = findings.filter(f => 
            f.toLowerCase().includes('manipul') || 
            f.toLowerCase().includes('emotion') || 
            f.toLowerCase().includes('mislead')
        );
        
        const missingContext = findings.filter(f => 
            f.toLowerCase().includes('missing') || 
            f.toLowerCase().includes('omit') || 
            f.toLowerCase().includes('fail to mention')
        );
        
        const hiddenPatterns = findings.filter(f => 
            !manipulationInsights.includes(f) && !missingContext.includes(f)
        );
        
        return `
            <div class="ai-insights">
                <h4 style="font-size: 20px; margin-bottom: 20px;">🧠 AI-Detected Hidden Patterns</h4>
                <p style="margin-bottom: 20px; color: #6b21a8;">
                    Our AI found subtle patterns that human readers typically miss. These insights reveal the "story behind the story":
                </p>
                
                ${manipulationInsights.length > 0 ? `
                <div class="insight-category">
                    <h5>🎭 Manipulation Tactics Detected</h5>
                    ${manipulationInsights.map(insight => `
                        <div class="insight-finding">
                            <strong>Finding:</strong> ${insight}
                        </div>
                    `).join('')}
                </div>` : ''}
                
                ${missingContext.length > 0 ? `
                <div class="insight-category">
                    <h5>❓ Missing Context & Omissions</h5>
                    ${missingContext.map(insight => `
                        <div class="insight-finding">
                            <strong>What's missing:</strong> ${insight}
                        </div>
                    `).join('')}
                </div>` : ''}
                
                ${hiddenPatterns.length > 0 ? `
                <div class="insight-category">
                    <h5>🔍 Subtle Patterns & Implications</h5>
                    ${hiddenPatterns.map(insight => `
                        <div class="insight-finding">
                            <strong>Hidden pattern:</strong> ${insight}
                        </div>
                    `).join('')}
                </div>` : ''}
                
                <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; text-align: center;">
                    <strong style="color: #6b21a8;">Why these insights matter:</strong>
                    <p style="margin-top: 10px; color: #64748b; line-height: 1.6;">
                        These patterns reveal how articles can influence readers without them realizing it. 
                        By understanding these tactics, you can read more critically and form your own informed opinions.
                    </p>
                </div>
            </div>
        `;
    }

    // Initialize interactions
    function initializeInteractions() {
        document.querySelectorAll('.dropdown-header').forEach(header => {
            header.addEventListener('click', function() {
                const dropdown = this.closest('.analysis-dropdown');
                const content = dropdown.querySelector('.dropdown-content');
                const icon = this.querySelector('.expand-icon') || this.querySelector('div:last-child');
                
                if (dropdown.classList.contains('expanded')) {
                    dropdown.classList.remove('expanded');
                    content.style.maxHeight = '0';
                    icon.textContent = '▼';
                } else {
                    dropdown.classList.add('expanded');
                    content.style.maxHeight = '2000px';
                    icon.textContent = '▲';
                }
            });
        });
    }

    // Animate trust meter
    function animateTrustMeter(score) {
        const circle = document.querySelector('.trust-meter-fill');
        if (circle) {
            const circumference = 691.15;
            const offset = circumference - (score / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }
    }

    // PDF Generation - Fixed
    window.generatePDF = function() {
        if (!currentAnalysisData) {
            showMessage('No analysis to save', 'error');
            return;
        }
        
        const button = document.getElementById('pdfButton');
        button.disabled = true;
        button.textContent = 'Generating PDF...';
        
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const results = currentAnalysisData.results;
            
            // Title
            doc.setFontSize(20);
            doc.text('AI News Analysis Report', 20, 20);
            
            // Date
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
            
            // Trust Score
            doc.setFontSize(16);
            doc.text(`Overall Trust Score: ${results.credibility || 0}%`, 20, 45);
            
            // Source & Author
            doc.setFontSize(12);
            doc.text(`Source: ${results.sources?.name || 'Unknown'}`, 20, 60);
            doc.text(`Author: ${results.author || 'Not specified'}`, 20, 70);
            
            // Summary
            doc.setFontSize(14);
            doc.text('Article Summary:', 20, 85);
            doc.setFontSize(10);
            const summary = results.summary || 'No summary available';
            const summaryLines = doc.splitTextToSize(summary, 170);
            doc.text(summaryLines, 20, 95);
            
            // Political Bias
            let yPosition = 95 + (summaryLines.length * 5) + 10;
            doc.setFontSize(14);
            doc.text('Political Bias Analysis:', 20, yPosition);
            doc.setFontSize(10);
            doc.text(`Detected: ${results.bias?.label || 'Unknown'}`, 20, yPosition + 10);
            doc.text(`Objectivity: ${results.bias?.objectivity || 0}%`, 20, yPosition + 20);
            
            // Save the PDF
            doc.save(`news-analysis-${Date.now()}.pdf`);
            
            showMessage('PDF report generated successfully!', 'success');
            
        } catch (error) {
            console.error('PDF generation error:', error);
            showMessage('Failed to generate PDF. Please try again.', 'error');
        } finally {
            button.disabled = false;
            button.textContent = '📄 Save as PDF Report';
        }
    }

    // Reset analysis
    window.resetAnalysis = function() {
        document.getElementById('articleUrl').value = '';
        document.getElementById('articleText').value = '';
        document.getElementById('results').classList.remove('active');
        currentAnalysisData = null;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Show messages
    function showMessage(text, type) {
        const message = document.createElement('div');
        message.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: ${type === 'error' ? '#fee2e2' : '#dcfce7'};
            color: ${type === 'error' ? '#991b1b' : '#166534'};
            border: 1px solid ${type === 'error' ? '#fecaca' : '#bbf7d0'};
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        `;
        message.textContent = text;
        document.body.appendChild(message);
        
        setTimeout(() => {
            message.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => message.remove(), 300);
        }, 5000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        console.log('AI News Intelligence System initialized');
    });
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

@keyframes slideOut {
    from { transform: translateX(0); }
    to { transform: translateX(100%); }
}
</style>
{% endblock %}
